{"version":3,"file":"devtools.js","sources":["../src/panel-polyfill.ts","../src/devtools.ts"],"sourcesContent":["// @ts-expect-error Needed for React\nglobalThis.process = { env: {} }\n","import './panel-polyfill.js'\n\nimport { ChromeExtension } from '@livestore/devtools-common'\nimport { shouldNeverHappen } from '@livestore/utils'\nimport { Effect, Fiber, Logger, LogLevel, Runtime, Scope, WebChannel } from '@livestore/utils/effect'\nimport * as Webmesh from '@livestore/webmesh'\n\nimport { BUILD_NUMBER } from './buildnumber.js'\nimport { connectViaServiceWorker } from './service-worker-edge.js'\n\nconst makeDevtoolsPanel = (panel: chrome.devtools.panels.ExtensionPanel, scope: Scope.CloseableScope) =>\n  Effect.gen(function* () {\n    const runtime = yield* Effect.runtime<Scope.Scope>()\n\n    const tabId = chrome.devtools.inspectedWindow.tabId\n\n    const webmeshNode = yield* Webmesh.makeMeshNode(ChromeExtension.makeNodeName.panel({ tabId }))\n\n    globalThis.__debugWebmeshNode = webmeshNode\n\n    yield* connectViaServiceWorker(webmeshNode, tabId).pipe(Effect.tapCauseLogPretty, Effect.forkIn(scope))\n\n    let alreadyLoaded = false\n\n    panel.onShown.addListener((panelWindow) =>\n      Effect.gen(function* () {\n        if (alreadyLoaded) return\n\n        alreadyLoaded = true\n\n        const rootEl = panelWindow.document.querySelector('#root')!\n\n        const inspectedWindowOrigin = yield* Effect.async<string>((cb) => {\n          chrome.devtools.inspectedWindow.eval(`location.origin`, (inspectedWindowOrigin) => {\n            cb(Effect.succeed(inspectedWindowOrigin as string))\n          })\n        })\n\n        const devtoolsUrl = `${inspectedWindowOrigin}/_livestore/browser-extension/?autoconnect&tabId=${tabId}`\n\n        // NOTE running this in the background to fail gracefully but optimistically attempt happy path\n        void fetch(devtoolsUrl).then(async (res) => {\n          const showErr = () => {\n            rootEl.innerHTML = `\\\n<div style=\"padding: 12px; font-size: 14px;\">\n  LiveStore Devtools entrypoint not found. Please make sure you have the LiveStore Devtools Vite plugin enabled.\n</div>`\n          }\n\n          if (res.ok === false) {\n            showErr()\n          }\n\n          const htmlContent = await res.text()\n\n          const isLiveStoreDevtoolsHtml = htmlContent.includes(`<meta name=\"livestore-devtools\" content=\"true\" />`)\n          if (isLiveStoreDevtoolsHtml === false) {\n            showErr()\n          }\n        })\n\n        // add iframe to rootEl\n        const iframe = panelWindow.document.createElement('iframe')\n        iframe.id = 'devtools-iframe'\n        iframe.style.width = '100%'\n        iframe.style.height = '100%'\n        iframe.src = devtoolsUrl\n\n        const startTime = performance.now()\n\n        iframe.addEventListener('load', () =>\n          Effect.gen(function* () {\n            const endTime = performance.now()\n\n            console.log(`Iframe loaded in ${(endTime - startTime).toFixed(2)}ms`)\n          }).pipe(Effect.tapCauseLogPretty, Runtime.runFork(runtime)),\n        )\n\n        rootEl.innerHTML = '' // remove loading message\n        rootEl.append(iframe)\n\n        yield* Effect.addFinalizer(() =>\n          Effect.gen(function* () {\n            iframe.remove()\n            rootEl.innerHTML = ''\n          }),\n        )\n\n        const iframeWindowChannel = yield* WebChannel.windowChannel({\n          listenWindow: panelWindow,\n          sendWindow: iframe.contentWindow!,\n          schema: Webmesh.WebmeshSchema.Packet,\n          ids: { own: 'devtools-panel', other: 'devtools' },\n        })\n\n        yield* webmeshNode.addEdge({\n          edgeChannel: iframeWindowChannel,\n          target: ChromeExtension.makeNodeName.devtools({ tabId }),\n        })\n\n        return yield* Effect.never\n      }).pipe(Effect.tapCauseLogPretty, Runtime.runFork(runtime)),\n    )\n\n    panel.onHidden.addListener(() => {\n      // Scope.close(scope, Exit.void).pipe(Effect.tapCauseLogPretty, Runtime.runFork(runtime))\n    })\n\n    return yield* Effect.never\n  }).pipe(Scope.extend(scope))\n\nconst main = Effect.gen(function* () {\n  const runtime = yield* Effect.runtime<never>()\n\n  if (chrome.runtime.lastError) {\n    console.error('chrome.runtime.lastError', chrome.runtime.lastError)\n    shouldNeverHappen(`Error when connecting to background page`)\n  }\n\n  // TODO in the future we should consider only creating the panel if there's already an AppHost detected\n  // Similar to how the React Devtools only add a panel when they've detected a React app\n  chrome.devtools.panels.create('LiveStore', 'icon128.png', 'panel.html', (panel) => {\n    Effect.gen(function* () {\n      // TODO do we really need the scope?\n      const scope = yield* Scope.make()\n      yield* makeDevtoolsPanel(panel, scope).pipe(Effect.forkIn(scope), Effect.andThen(Fiber.await))\n    }).pipe(Effect.forever, Effect.tapCauseLogPretty, Runtime.runFork(runtime))\n  })\n})\n\nmain.pipe(\n  Effect.scoped,\n  Effect.tapCauseLogPretty,\n  Effect.annotateLogs({ thread: 'devtools-panel', BUILD_NUMBER }),\n  Effect.provide(Logger.prettyWithThread('devtools-panel')),\n  Logger.withMinimumLogLevel(LogLevel.Debug),\n  Effect.runFork,\n)\n"],"names":["Effect.gen","runtime","Effect.runtime","Webmesh.makeMeshNode","ChromeExtension.makeNodeName","Effect.tapCauseLogPretty","Effect.forkIn","Effect.async","inspectedWindowOrigin","Effect.succeed","Runtime.runFork","Effect.addFinalizer","WebChannel.windowChannel","Webmesh.WebmeshSchema.Packet","Effect.never","Scope.extend","Scope.make","Effect.andThen","Fiber.await","Effect.forever","Effect.scoped","Effect.annotateLogs","Effect.provide","Logger.prettyWithThread","Logger.withMinimumLogLevel","LogLevel.Debug","Effect.runFork"],"mappings":"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"}
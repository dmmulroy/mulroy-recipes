{"version":3,"file":"contentscript-iframe.js","sources":["../src/contentscript-iframe.ts"],"sourcesContent":["import { ChromeExtension } from '@livestore/devtools-common'\nimport { Effect, Logger, LogLevel, Schema, WebChannel } from '@livestore/utils/effect'\nimport * as Webmesh from '@livestore/webmesh'\n\nimport { BUILD_NUMBER } from './buildnumber.js'\nimport { ContentscriptIframeSearchParamsSchema } from './schemas.js'\nimport { connectViaServiceWorker } from './service-worker-edge.js'\n\n/**\n * Origin: Extension\n *\n * Iframe gets bootstrapped by and runs in `contentscript-main`.\n * Establishes a Webmesh connection to the extension background worker via `navigator.serviceWorker`.\n */\n\nconst main = Effect.gen(function* () {\n  const searchParams = new URL(globalThis.location.href).searchParams\n  const { tabId } = yield* Schema.decodeUnknown(ContentscriptIframeSearchParamsSchema)(\n    Object.fromEntries(searchParams.entries()),\n  )\n\n  const webmeshNode = yield* Webmesh.makeMeshNode(ChromeExtension.makeNodeName.contentscriptIframe({ tabId }))\n\n  globalThis.__debugWebmeshNode = webmeshNode\n\n  const contentscriptMainNodeName = ChromeExtension.makeNodeName.contentscriptMain({ tabId })\n\n  const contentscriptMainChannel = yield* WebChannel.windowChannel({\n    // eslint-disable-next-line unicorn/prefer-global-this\n    listenWindow: window,\n    sendWindow: window.parent,\n    schema: Webmesh.WebmeshSchema.Packet,\n    ids: { own: webmeshNode.nodeName, other: contentscriptMainNodeName },\n  })\n\n  yield* webmeshNode.addEdge({\n    target: contentscriptMainNodeName,\n    edgeChannel: contentscriptMainChannel,\n  })\n\n  return yield* connectViaServiceWorker(webmeshNode, tabId)\n})\n\nmain.pipe(\n  Effect.scoped,\n  Effect.tapCauseLogPretty,\n  Effect.annotateLogs({ thread: 'contentscript-iframe', origin: 'extension', BUILD_NUMBER }),\n  Effect.provide(Logger.prettyWithThread('contentscript-iframe')),\n  Logger.withMinimumLogLevel(LogLevel.Debug),\n  Effect.runFork,\n)\n"],"names":["Effect.gen","Schema.decodeUnknown","Webmesh.makeMeshNode","ChromeExtension.makeNodeName","WebChannel.windowChannel","Webmesh.WebmeshSchema.Packet","Effect.scoped","Effect.tapCauseLogPretty","Effect.annotateLogs","Effect.provide","Logger.prettyWithThread","Logger.withMinimumLogLevel","LogLevel.Debug","Effect.runFork"],"mappings":";;;AAeA,MAAM,OAAOA,IAAW,aAAa;AACnC,QAAM,eAAe,IAAI,IAAI,WAAW,SAAS,IAAI,EAAE;AACvD,QAAM,EAAE,MAAA,IAAU,OAAOC,cAAqB,qCAAqC;AAAA,IACjF,OAAO,YAAY,aAAa,QAAA,CAAS;AAAA,EAAA;AAG3C,QAAM,cAAc,OAAOC,aAAqBC,aAA6B,oBAAoB,EAAE,MAAA,CAAO,CAAC;AAE3G,aAAW,qBAAqB;AAEhC,QAAM,4BAA4BA,aAA6B,kBAAkB,EAAE,OAAO;AAE1F,QAAM,2BAA2B,OAAOC,cAAyB;AAAA;AAAA,IAE/D,cAAc;AAAA,IACd,YAAY,OAAO;AAAA,IACnB,QAAQC;AAAAA,IACR,KAAK,EAAE,KAAK,YAAY,UAAU,OAAO,0BAAA;AAAA,EAA0B,CACpE;AAED,SAAO,YAAY,QAAQ;AAAA,IACzB,QAAQ;AAAA,IACR,aAAa;AAAA,EAAA,CACd;AAED,SAAO,OAAO,wBAAwB,aAAa,KAAK;AAC1D,CAAC;AAED,KAAK;AAAA,EACHC;AAAAA,EACAC;AAAAA,EACAC,aAAoB,EAAE,QAAQ,wBAAwB,QAAQ,aAAa,cAAc;AAAA,EACzFC,QAAeC,iBAAwB,sBAAsB,CAAC;AAAA,EAC9DC,oBAA2BC,KAAc;AAAA,EACzCC;AACF;"}